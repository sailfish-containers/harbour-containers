:toc:
:toc-placement!:
:toclevels: 4

= Containers

_A LXC manager and runner for SailfishOS_

image::https://raw.githubusercontent.com/sailfish-containers/harbour-containers/master/icons/172x172/harbour-containers.png[]  

:toc: macro

==== ———
toc::[]

== Documentation

=== What is it?
_Containers_ (`harbour-containers`) is a SailfishOS application to create, download, manage and run Linux containers (LXC) from a convenient GUI. It relies on `Xwayland` to run the associated desktop environment inside a new SailifshOS window:

image::pics/Screenshot_20220817_005_800.png[]
image::pics/Screenshot_20220817_004_800.png[]
image::pics/E5vInvOWQAMcxLg_800.jpeg[]

=== Installation
NOTE: Before proceeding, make sure  https://github.com/sailfish-containers/lxc-templates-desktop/wiki/Requirements[LXC kernel requirements] are satisfied.

===== From Chum community repository (stable)
If you had a version of `harbour-containers` installed from a source other than Chum (from example an older version or a devel build), then you need to uninstall it first because Chum is designed to *not* overwrite packages if they don't match vendor (presumably installed manually):

[source,bash]
----
devel-su
ps aux | grep -ie daemon.py | awk '{print $2}' | xargs kill -9 2> /dev/null # Kill the daemon
zypper remove harbour-containers qxcompositor lxc-templates-dekstop # Uninstall packages
zypper remove qxdisplay # Just in case you have it too as it is obsolete now
----

Install Chum from https://chumrpm.netlify.app/[here], then search for "Containers" in its app list. You're done.

image::pics/Screenshot_20220818_001_480.png[]

===== From command line (devel builds)
1. Install dependencies:
+
[source,bash]
----
devel-su
pkcon install zypper # If you don't have it installed already
zypper install nemo-qml-plugin-dbus-qt5 sailfish-polkit-agent python3-base python3-gobject dbus-python3 xz
----
+
[start=2]
2. https://repo.sailfishos.org/obs/home:/kabouik/[From the folder matching your SFOS version and device architecture], manually download the following packages:
 * `lxc-templates-desktop` ("noarch" subfolder),
 * `qxcompositor` (your architecture subfolder),
 * `harbour-containers` (your architecture subfolder too).

3. Install them either from your SailfishOS file manager or using:
+
[source,bash]
----
cd /path/to/directory/where/you/downloaded/the/three/rpms
devel-su
ps aux | grep -ie daemon.py | awk '{print $2}' | xargs kill -9 2> /dev/null # Kill the daemon in case an older version was running
zypper install lxc-templates-dekstop-<VERSION>.rpm
zypper install qxcompositor-<VERSION>.rpm
zypper install harbour-containers-<VERSION>.rpm
----

Those three packages will have to be uninstalled manually before stable builds can be installed from Chum again, see above section.

=== How to use?
The GUI of `harbour-containers` should be relatively straightforward, see a brief description of GUI elements below:

.Click to expand the description of each GUI element
[%collapsible]
====
`▶ Main page`

    ⨁  icon:: Create a new container (you will need to set a device lock code in SailfishOS settings first), **only Debian-based distributions are supported at the moment**

`*▶ Container creation page*`

    Setup desktop:: Execute a script after container creation to install a basic desktop environment (this can be done later too)

`*▶ Existing container page*`

    attach:: Open a terminal window as `root` within the contained distribution
    X session::  Open a new SailfishOS window showing the X desktop of the distribution, if the desktop was set up first
    mountpoints::  List of the default mount points for the container (you can edit it in `/var/lib/lxc/<container-name>/config`)
    run onboard::  Show a floating icon in the X session that allows opening a virtual keyboard (long press on Return to close it)
    kill Xwayland::  May be necessary to close and reopen (with the "X session" button above" the window showing the desktop environment
    setup xsession::  Run a script to set up your user and password, as well as default settings for your desktop environment (same as "Setup desktop" above in the container creation page)
    init container config::  Run this first after container creation if you didn't check "Setup desktop" in the first place; can only be ran on a stopped container

`*▶ Pulley menus*`

    Settings::  Change container icon, destroy container (this cannot be undone), or set fixed orientation (obsolete)
    Snapshots::  View LXC snapshots created using `lxc-snapshot` (see https://github.com/sailfish-containers/lxc-templates-desktop/wiki[lxc-templates-desktop's wiki])
    Freeze/Unfreeze (all)::  Freeze/Unfreeze container to save resources
    Start/Stop (all)::  Start/stop container
====

If unfortunately you checked "Setup desktop" when creating a new container but just saw the new container icon appear and then stop witnout a new terminal window prompting your for a user password, then the user and desktop have not been configured. Go into that container page in the GUI, press "init container config", and then "setup xsession".

See https://github.com/sailfish-containers/lxc-templates-desktop/wiki[lxc-templates-desktop's wiki] for more details and CLI usage (with extra features). 

== Discussion
See the https://talk.maemo.org/showthread.php?t=101080[TMO thread].

== Demos

* Debian with i3 WM on a Pro1x running SailfishOS, with dynamic rotation (and rotation lock with keyboard opening):
+
image::pics/dynamicorientation.gif[]

* Kali with XFCE4 alongside SailfishOS:
+
image::pics/99102454-feeae200-25d5-11eb-935f-b846233e8808.gif[]  

* You can run any Linux desktop application that has been compiled for your architecture. See for instance `rofi` and `Darktable` below:
+
image::pics/99102434-fa262e00-25d5-11eb-853f-f203327f9a55.gif[]  

* While LXC containers of desktop Linux distributions are most convenient with a hardware keyboard phone like the F(x)tec Pro1 and Pro1x, `Onboard` is also preinstalled for compatibility with other smartphones:
+
image::pics/99102422-f5fa1080-25d5-11eb-9d74-b7a09c1a9a22.gif[]  

*  More pics:
+
image::pics/EmdbYnRXIAEZlLb_800.jpeg[]
image::pics/EmdbYpVXYAA9Ou6_800.jpeg[]
image::pics/Eo_d7waW4AI17FB_800.jpeg[]
image::pics/FSpmvrBWQAAqPL2_800.jpeg[]

* A video showcasing what LXC containers can do on SailfishOS is available https://youtu.be/-dgD5jci8Dk[here]. Moar videos https://movio.sauru.sh/mobilelinux[here].

== Known issues/limitations

* No sound in aarch64 devices (or please tell us)
* No hardware acceleration
* Only prebuilt binaries of Xwayland can be used at the moment inside containers (this is automated when setting up xsession from the GUI), because latest sources don't support the XDG_WM_Base protocol that we need

== License
This project is proudly licensed under GNU GPLv3.

== Credits
Many thanks to all contributors and testers: 
 
* https://github.com/r3vn[r3vn (main dev)] - https://github.com/g7[g7] - https://github.com/Kabouik[kabouik] - https://github.com/eLtMosen[eLtMosen] - https://github.com/elros34[elros34] - https://github.com/edp17[edp17] - https://github.com/vaskas[vaskas] - https://github.com/sashinfantry[dashinfantry] - https://github.com/hengyedev[HengYeDev]  
* https://www.flaticon.com/free-icons/container-ship[Container ship icon modified from Freepik - Flaticon]
